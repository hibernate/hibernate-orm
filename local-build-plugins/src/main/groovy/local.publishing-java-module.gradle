/*
 * SPDX-License-Identifier: Apache-2.0
 * Copyright Red Hat Inc. and Hibernate Authors
 */

plugins {
    id "local.java-module"
    id "local.publishing"
    id "local.code-quality"
}

// Ideally this should be in `local.java-module.gradle`,
// but we need to skip this in hibernate-gradle-plugin.
def skipJacoco = project.hasProperty('skipJacoco') ? project.getProperty('skipJacoco').toBoolean() : false
if (!skipJacoco) {
    plugins.apply('jacoco')
}

configurations {
    javadocSources {
        description = "All Java sources for the project's Javadoc"
        canBeConsumed = true
        canBeResolved = false
        visible = false
    }
}

dependencies {
    javadocSources sourceSets.main.allJava.filter { file ->
        !file.path.contains( "/internal/" )
    }
}


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Publishing

var publishingExtension = project.getExtensions().getByType(PublishingExtension) as PublishingExtension
publishingExtension.publications.named("publishedArtifacts", MavenPublication) {
    // Add the Java component to the main publication
    from components.java
}


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Releasing

def releasePrepareTask = tasks.register("releasePrepare") {
    group = "release"
    description = "See :release:releasePrepare for details.  Here we hook in testing and checks ensure publish-ability"

    dependsOn tasks.check
    dependsOn tasks.generateMetadataFileForPublishedArtifactsPublication
    dependsOn tasks.generatePomFileForPublishedArtifactsPublication
}

// used from the h2 CI job
tasks.register("preVerifyRelease") {
    group = "release-prepare"
    description = "Delegates to `releasePrepare` task"

    dependsOn releasePrepareTask
}

