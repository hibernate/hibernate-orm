import java.nio.charset.StandardCharsets
import java.util.function.Function

import groovy.json.JsonSlurper

/*
 * Hibernate, Relational Persistence for Idiomatic Java
 *
 * License: GNU Lesser General Public License (LGPL), version 2.1 or later.
 * See the lgpl.txt file in the root directory or <http://www.gnu.org/licenses/lgpl-2.1.html>.
 */
apply from: rootProject.file( 'gradle/module.gradle' )

apply plugin: 'org.hibernate.orm.build.jdks'
apply plugin: 'idea'

idea.module {
}

// skip building this when `build` task is run from root, as many of our CI jobs do
tasks.build.dependsOn.clear()


def stageIntegrationGuideTask = tasks.register( "stageIntegrationGuide", Copy ) {
    group "documentation"
    description "Stages the Integration Guide as part of preparing for release"
    dependsOn ":documentation:renderIntegrationGuides"

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/integrationguide" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/integrationguide")
}

def stageQuickstartTask = tasks.register( "stageQuickstart", Copy ) {
    group 'documentation'
    description "Stages the Getting Started Guide as part of preparing for release"
    dependsOn ':documentation:renderGettingStartedGuides'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/quickstart" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/quickstart")
}

def stageTopicalGuideTask = tasks.register( "stageTopicalGuide", Copy ) {
    group 'documentation'
    description "Stages the Topical Guide as part of preparing for release"
    dependsOn ':documentation:renderTopicalGuides'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/topical" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/topical")
}

def stageIntroductionGuideTask = tasks.register( "stageIntroductionGuide", Copy ) {
    group 'documentation'
    description "Stages the Introduction Guide as part of preparing for release"
    dependsOn ':documentation:renderIntroductionGuides'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/introduction" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/introduction")
}

def stageQueryGuideTasks = tasks.register( "stageQueryGuide", Copy ) {
    group 'documentation'
    description "Stages the Query Language Guide as part of preparing for release"
    dependsOn ':documentation:renderQueryLanguageGuides'
    description "Stages the Query Language Guide as part of preparing for release"
    dependsOn ':documentation:renderQueryLanguageGuides'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/querylanguage" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/querylanguage")
}

def stageRepositoriesGuideTask = tasks.register( "stageRepositoriesGuide", Copy ) {
    group 'documentation'
    description "Stages the Repositories Guide as part of preparing for release"
    dependsOn ':documentation:renderRepositories'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/repositories" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/repositories")
}

def stageUserGuideTask = tasks.register( "stageUserGuide", Copy ) {
    group 'documentation'
    description "Stages the User Guide as part of preparing for release"
    dependsOn ':documentation:renderUserGuides'
    description "Stages the User Guide as part of preparing for release"
    dependsOn ':documentation:renderUserGuides'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/userguide" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/userguide")
}


def stageMigrationGuideTask = tasks.register( "stageMigrationGuide", Copy ) {
    group 'documentation'
    description "Stages the Migration Guide as part of preparing for release"
    dependsOn ':documentation:renderMigrationGuide'

    from project.provider { project( ":documentation" ).layout.buildDirectory.dir( "asciidoc/migration-guide" ) }
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/migration-guide")
}

def stageIncubationReportTask = tasks.register( "stageIncubationReport", Copy ) { task ->
    group 'documentation'
    description "Stages ORM @Incubating report"
    dependsOn ':documentation:generateIncubationReport'

    tasks.stageOrmReports.dependsOn task

    from project( ":documentation" ).tasks.generateIncubationReport
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/incubating")
}

def stageInternalsReportTask = tasks.register( "stageInternalsReport", Copy ) { task ->
    group 'documentation'
    description "Stages the @Internal report"
    dependsOn ':documentation:generateInternalsReport'

    from project( ":documentation" ).tasks.generateInternalsReport
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/internals")
}

def stageDeprecationReportTask = tasks.register( "stageDeprecationReport", Copy ) {
    group 'documentation'
    description "Stages the @Deprecated/@Remove report"

    dependsOn ':documentation:generateDeprecationReport'

    from project( ":documentation" ).tasks.generateDeprecationReport
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/deprecated")
}

def stageLoggingReportTask = tasks.register( "stageLoggingReport", Copy ) { task ->
    group 'documentation'
    description "Stages the logging report"

    dependsOn ':documentation:renderLoggingReport'

    from project( ":documentation" ).tasks.renderLoggingReport
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/logging")
}

def stageDialectReportTask = tasks.register( "stageDialectReport", Copy ) { task ->
    group 'documentation'
    description "Stages the supported Dialects report"
    dependsOn ':documentation:renderDialectReport'

    from project( ":documentation" ).tasks.renderDialectReport
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/dialect")
}

def stageOrmReportsTask = tasks.register( "stageOrmReports" ) {
    group 'documentation'
    description "Stages all ORM reports as part of preparing for release"

    dependsOn ':documentation:generateReports'
    dependsOn stageIncubationReportTask
    dependsOn stageInternalsReportTask
    dependsOn stageDeprecationReportTask
    dependsOn stageLoggingReportTask
    dependsOn stageDialectReportTask
}

def stageJavadocsTask = tasks.register( "stageJavadocs", Copy ) {
    group 'documentation'
    description "Stages the aggregated Javadocs"
    dependsOn ':documentation:javadoc'

    from project( ":documentation" ).tasks.javadoc
    into rootProject.layout.buildDirectory.dir("staging-deploy/documentation/javadocs")
}

/**
 * Assembles all documentation into the {buildDir}/documentation directory.
 *
 * Depends on building the docs
 */
def assembleDocumentationTask = tasks.register( "assembleDocumentation" ) {
    group 'documentation'
    description 'Assembles all documentation into the {buildDir}/staging-deploy/documentation directory'

    dependsOn ':documentation:buildDocsForPublishing'
    dependsOn stageJavadocsTask
    dependsOn stageQuickstartTask
    dependsOn stageIntroductionGuideTask
    dependsOn stageUserGuideTask
    dependsOn stageQueryGuideTasks
    dependsOn stageIntegrationGuideTask
    dependsOn stageTopicalGuideTask
    dependsOn stageMigrationGuideTask
    dependsOn stageOrmReportsTask
}

def releasePrepareTask = tasks.register( 'releasePrepare' ) {
    group 'Release'
    description 'Performs release preparations on local check-out, including updating changelog'

    // we want to assemble the docs here so that we catch problems early (and even during "dry run" for CI releases)
    dependsOn assembleDocumentationTask
}
